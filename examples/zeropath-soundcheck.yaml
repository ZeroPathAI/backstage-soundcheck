soundcheck:
  collectors:
    zeropath:
      frequency:
        minutes: 30
      initialDelay:
        seconds: 30
      batchSize: 50
      cache:
        duration:
          hours: 1
      collects:
        - filter:
            - kind:
                - component

  checks:
    - id: zeropath-linked
      ownerEntityRef: group:default/guests
      name: ZeroPath repository linked
      description: Ensures every component maps to a ZeroPath repository.
      rule:
        all:
          - factRef: zeropath:default/is_configured
            path: $.value
            operator: equal
            value: true
      filter:
        - kind:
            - component
      passedMessage: '{{ entity.metadata.name }} has a linked ZeroPath repository.'
      failedMessage: '{{ entity.metadata.name }} needs a github.com/project-slug annotation matching the ZeroPath repository slug.'

    - id: zeropath-pr-scanning
      ownerEntityRef: group:default/guests
      name: ZeroPath PR scanning enabled
      description: Requires ZeroPath PR scanning to be enabled for the repository.
      rule:
        any:
          - all:
              - factRef: zeropath:default/is_configured
                path: $.value
                operator: equal
                value: true
              - factRef: zeropath:default/pr_scanning_enabled
                path: $.value
                operator: equal
                value: true
          - all:
              - factRef: zeropath:default/is_configured
                path: $.value
                operator: equal
                value: false
      notApplicableMessage: '{{ entity.metadata.name }} is not linked to ZeroPath.'
      filter:
        - kind:
            - component
      passedMessage: '{{ entity.metadata.name }} has ZeroPath PR scanning enabled.'
      failedMessage: '{{ entity.metadata.name }} needs ZeroPath PR scanning enabled.'

    - id: zeropath-critical-zero
      ownerEntityRef: group:default/guests
      name: Critical ZeroPath issues remediated
      description: Fails if ZeroPath reports any critical issues.
      rule:
        any:
          - all:
              - factRef: zeropath:default/is_configured
                path: $.value
                operator: equal
                value: true
              - factRef: zeropath:default/issues_critical_count
                path: $.value
                operator: lessThanInclusive
                value: 0
          - all:
              - factRef: zeropath:default/is_configured
                path: $.value
                operator: equal
                value: false
      notApplicableMessage: '{{ entity.metadata.name }} is not linked to ZeroPath.'
      filter:
        - kind:
            - component
      passedMessage: '{{ entity.metadata.name }} has no critical ZeroPath issues.'
      failedMessage: '{{ entity.metadata.name }} has critical ZeroPath issues that need remediation.'

    - id: zeropath-high-zero
      ownerEntityRef: group:default/guests
      name: High ZeroPath issues remediated
      description: Fails if ZeroPath reports any high severity issues.
      rule:
        any:
          - all:
              - factRef: zeropath:default/is_configured
                path: $.value
                operator: equal
                value: true
              - factRef: zeropath:default/issues_high_count
                path: $.value
                operator: lessThanInclusive
                value: 0
          - all:
              - factRef: zeropath:default/is_configured
                path: $.value
                operator: equal
                value: false
      notApplicableMessage: '{{ entity.metadata.name }} is not linked to ZeroPath.'
      filter:
        - kind:
            - component
      passedMessage: '{{ entity.metadata.name }} has no high severity ZeroPath issues.'
      failedMessage: '{{ entity.metadata.name }} has high severity ZeroPath issues that need remediation.'

  tracks:
    - id: zeropath-security-posture
      name: ZeroPath Security Posture
      description: Ensures catalog components stay connected to ZeroPath and have no outstanding high or critical issues.
      ownerEntityRef: group:default/guests
      filter:
        - kind:
            - component
      levels:
        - ordinal: 1
          name: Connected
          description: Entity is linked to a ZeroPath repository.
          checks:
            - id: zeropath-linked
              name: ZeroPath repository linked
              description: Confirms the component has a matching ZeroPath repository.
        - ordinal: 2
          name: Healthy posture
          description: ZeroPath PR scanning is enabled and there are no outstanding high or critical issues.
          checks:
            - id: zeropath-pr-scanning
              name: ZeroPath PR scanning enabled
              description: ZeroPath PR scanning is enabled for the repository.
            - id: zeropath-critical-zero
              name: Critical ZeroPath issues remediated
              description: ZeroPath reports zero critical issues.
            - id: zeropath-high-zero
              name: High ZeroPath issues remediated
              description: ZeroPath reports zero high severity issues.
